<html>

<head>
<meta http-equiv=Content-Type content="text/html; charset=windows-1252">
<meta name=Generator content="Microsoft Word 14 (filtered)">
<style>
<!--
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin:0in;
	margin-bottom:.0001pt;
	line-height:115%;
	font-size:11.0pt;
	font-family:"Arial","sans-serif";
	color:black;}
h1
	{margin-top:20.0pt;
	margin-right:0in;
	margin-bottom:6.0pt;
	margin-left:0in;
	line-height:115%;
	page-break-after:avoid;
	font-size:20.0pt;
	font-family:"Arial","sans-serif";
	color:black;
	font-weight:normal;}
h1.CxSpFirst
	{margin-top:20.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:0in;
	margin-bottom:.0001pt;
	line-height:115%;
	page-break-after:avoid;
	font-size:20.0pt;
	font-family:"Arial","sans-serif";
	color:black;
	font-weight:normal;}
h1.CxSpMiddle
	{margin:0in;
	margin-bottom:.0001pt;
	line-height:115%;
	page-break-after:avoid;
	font-size:20.0pt;
	font-family:"Arial","sans-serif";
	color:black;
	font-weight:normal;}
h1.CxSpLast
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:6.0pt;
	margin-left:0in;
	line-height:115%;
	page-break-after:avoid;
	font-size:20.0pt;
	font-family:"Arial","sans-serif";
	color:black;
	font-weight:normal;}
h2
	{margin-top:.25in;
	margin-right:0in;
	margin-bottom:6.0pt;
	margin-left:0in;
	line-height:115%;
	page-break-after:avoid;
	font-size:16.0pt;
	font-family:"Arial","sans-serif";
	color:black;
	font-weight:normal;}
h2.CxSpFirst
	{margin-top:.25in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:0in;
	margin-bottom:.0001pt;
	line-height:115%;
	page-break-after:avoid;
	font-size:16.0pt;
	font-family:"Arial","sans-serif";
	color:black;
	font-weight:normal;}
h2.CxSpMiddle
	{margin:0in;
	margin-bottom:.0001pt;
	line-height:115%;
	page-break-after:avoid;
	font-size:16.0pt;
	font-family:"Arial","sans-serif";
	color:black;
	font-weight:normal;}
h2.CxSpLast
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:6.0pt;
	margin-left:0in;
	line-height:115%;
	page-break-after:avoid;
	font-size:16.0pt;
	font-family:"Arial","sans-serif";
	color:black;
	font-weight:normal;}
h3
	{margin-top:16.0pt;
	margin-right:0in;
	margin-bottom:4.0pt;
	margin-left:0in;
	line-height:115%;
	page-break-after:avoid;
	font-size:14.0pt;
	font-family:"Arial","sans-serif";
	color:#434343;
	font-weight:normal;}
h3.CxSpFirst
	{margin-top:16.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:0in;
	margin-bottom:.0001pt;
	line-height:115%;
	page-break-after:avoid;
	font-size:14.0pt;
	font-family:"Arial","sans-serif";
	color:#434343;
	font-weight:normal;}
h3.CxSpMiddle
	{margin:0in;
	margin-bottom:.0001pt;
	line-height:115%;
	page-break-after:avoid;
	font-size:14.0pt;
	font-family:"Arial","sans-serif";
	color:#434343;
	font-weight:normal;}
h3.CxSpLast
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:4.0pt;
	margin-left:0in;
	line-height:115%;
	page-break-after:avoid;
	font-size:14.0pt;
	font-family:"Arial","sans-serif";
	color:#434343;
	font-weight:normal;}
h4
	{margin-top:14.0pt;
	margin-right:0in;
	margin-bottom:4.0pt;
	margin-left:0in;
	line-height:115%;
	page-break-after:avoid;
	font-size:12.0pt;
	font-family:"Arial","sans-serif";
	color:#666666;
	font-weight:normal;}
h4.CxSpFirst
	{margin-top:14.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:0in;
	margin-bottom:.0001pt;
	line-height:115%;
	page-break-after:avoid;
	font-size:12.0pt;
	font-family:"Arial","sans-serif";
	color:#666666;
	font-weight:normal;}
h4.CxSpMiddle
	{margin:0in;
	margin-bottom:.0001pt;
	line-height:115%;
	page-break-after:avoid;
	font-size:12.0pt;
	font-family:"Arial","sans-serif";
	color:#666666;
	font-weight:normal;}
h4.CxSpLast
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:4.0pt;
	margin-left:0in;
	line-height:115%;
	page-break-after:avoid;
	font-size:12.0pt;
	font-family:"Arial","sans-serif";
	color:#666666;
	font-weight:normal;}
h5
	{margin-top:12.0pt;
	margin-right:0in;
	margin-bottom:4.0pt;
	margin-left:0in;
	line-height:115%;
	page-break-after:avoid;
	font-size:11.0pt;
	font-family:"Arial","sans-serif";
	color:#666666;
	font-weight:normal;}
h5.CxSpFirst
	{margin-top:12.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:0in;
	margin-bottom:.0001pt;
	line-height:115%;
	page-break-after:avoid;
	font-size:11.0pt;
	font-family:"Arial","sans-serif";
	color:#666666;
	font-weight:normal;}
h5.CxSpMiddle
	{margin:0in;
	margin-bottom:.0001pt;
	line-height:115%;
	page-break-after:avoid;
	font-size:11.0pt;
	font-family:"Arial","sans-serif";
	color:#666666;
	font-weight:normal;}
h5.CxSpLast
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:4.0pt;
	margin-left:0in;
	line-height:115%;
	page-break-after:avoid;
	font-size:11.0pt;
	font-family:"Arial","sans-serif";
	color:#666666;
	font-weight:normal;}
h6
	{margin-top:12.0pt;
	margin-right:0in;
	margin-bottom:4.0pt;
	margin-left:0in;
	line-height:115%;
	page-break-after:avoid;
	font-size:11.0pt;
	font-family:"Arial","sans-serif";
	color:#666666;
	font-weight:normal;
	font-style:italic;}
h6.CxSpFirst
	{margin-top:12.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:0in;
	margin-bottom:.0001pt;
	line-height:115%;
	page-break-after:avoid;
	font-size:11.0pt;
	font-family:"Arial","sans-serif";
	color:#666666;
	font-weight:normal;
	font-style:italic;}
h6.CxSpMiddle
	{margin:0in;
	margin-bottom:.0001pt;
	line-height:115%;
	page-break-after:avoid;
	font-size:11.0pt;
	font-family:"Arial","sans-serif";
	color:#666666;
	font-weight:normal;
	font-style:italic;}
h6.CxSpLast
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:4.0pt;
	margin-left:0in;
	line-height:115%;
	page-break-after:avoid;
	font-size:11.0pt;
	font-family:"Arial","sans-serif";
	color:#666666;
	font-weight:normal;
	font-style:italic;}
p.MsoTitle, li.MsoTitle, div.MsoTitle
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:3.0pt;
	margin-left:0in;
	line-height:115%;
	page-break-after:avoid;
	font-size:26.0pt;
	font-family:"Arial","sans-serif";
	color:black;}
p.MsoTitleCxSpFirst, li.MsoTitleCxSpFirst, div.MsoTitleCxSpFirst
	{margin:0in;
	margin-bottom:.0001pt;
	line-height:115%;
	page-break-after:avoid;
	font-size:26.0pt;
	font-family:"Arial","sans-serif";
	color:black;}
p.MsoTitleCxSpMiddle, li.MsoTitleCxSpMiddle, div.MsoTitleCxSpMiddle
	{margin:0in;
	margin-bottom:.0001pt;
	line-height:115%;
	page-break-after:avoid;
	font-size:26.0pt;
	font-family:"Arial","sans-serif";
	color:black;}
p.MsoTitleCxSpLast, li.MsoTitleCxSpLast, div.MsoTitleCxSpLast
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:3.0pt;
	margin-left:0in;
	line-height:115%;
	page-break-after:avoid;
	font-size:26.0pt;
	font-family:"Arial","sans-serif";
	color:black;}
p.MsoSubtitle, li.MsoSubtitle, div.MsoSubtitle
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:16.0pt;
	margin-left:0in;
	line-height:115%;
	page-break-after:avoid;
	font-size:15.0pt;
	font-family:"Arial","sans-serif";
	color:#666666;}
p.MsoSubtitleCxSpFirst, li.MsoSubtitleCxSpFirst, div.MsoSubtitleCxSpFirst
	{margin:0in;
	margin-bottom:.0001pt;
	line-height:115%;
	page-break-after:avoid;
	font-size:15.0pt;
	font-family:"Arial","sans-serif";
	color:#666666;}
p.MsoSubtitleCxSpMiddle, li.MsoSubtitleCxSpMiddle, div.MsoSubtitleCxSpMiddle
	{margin:0in;
	margin-bottom:.0001pt;
	line-height:115%;
	page-break-after:avoid;
	font-size:15.0pt;
	font-family:"Arial","sans-serif";
	color:#666666;}
p.MsoSubtitleCxSpLast, li.MsoSubtitleCxSpLast, div.MsoSubtitleCxSpLast
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:16.0pt;
	margin-left:0in;
	line-height:115%;
	page-break-after:avoid;
	font-size:15.0pt;
	font-family:"Arial","sans-serif";
	color:#666666;}
.MsoChpDefault
	{font-family:"Arial","sans-serif";
	color:black;}
.MsoPapDefault
	{line-height:115%;}
 /* Page Definitions */
 @page WordSection1
	{size:8.5in 11.0in;
	margin:1.0in 1.0in 1.0in 1.0in;}
div.WordSection1
	{page:WordSection1;}
 /* List Definitions */
 ol
	{margin-bottom:0in;}
ul
	{margin-bottom:0in;}
-->
</style>

</head>

<body bgcolor=white lang=EN-US>

<div class=WordSection1>

<p class=MsoTitle><a name="_bigkgby4lvhm"></a>VTI Router Implementation</p>

<p class=MsoNormal><span style='font-size:14.0pt;line-height:115%'>Table of
Content</span></p>

<p class=MsoNormal style='margin-top:4.0pt;line-height:normal'><a
href="#_flq0qiau6goa"><span style='color:#1155CC'>Disclaimer and CopyRights</span></a></p>

<p class=MsoNormal style='margin-top:3.0pt;margin-right:0in;margin-bottom:0in;
margin-left:.25in;margin-bottom:.0001pt;line-height:normal'><a
href="#_v795s5lio260"><span style='color:#1155CC'>VTI tunnels and their status.</span></a></p>

<p class=MsoNormal style='margin-top:3.0pt;margin-right:0in;margin-bottom:0in;
margin-left:.25in;margin-bottom:.0001pt;line-height:normal'><a
href="#_cfwjhbohirbg"><span style='color:#1155CC'>Directories and files.</span></a></p>

<p class=MsoNormal style='margin-top:3.0pt;margin-right:0in;margin-bottom:0in;
margin-left:.25in;margin-bottom:.0001pt;line-height:normal'><a
href="#_hrvw39imifu7"><span style='color:#1155CC'>File formats.</span></a></p>

<p class=MsoNormal style='margin-top:10.0pt;margin-right:0in;margin-bottom:
4.0pt;margin-left:0in;line-height:normal'><a href="#_tyxklp2ui5gz"><span
style='color:#1155CC'>APPENDIX. Scripts options.</span></a></p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

<h1 align=center style='text-align:center;line-height:137%;page-break-after:
auto'><a name="_flq0qiau6goa"></a><b>Disclaimer </b></h1>

<p class=MsoNormal style='line-height:137%'>VTI appliance created in EIS Group
and published into public domain under GPL licence.</p>

<p class=MsoNormal align=center style='text-align:center;line-height:137%'><span
style='font-size:8.0pt;line-height:137%;font-family:"Courier New"'>#####################################################</span></p>

<p class=MsoNormal align=center style='text-align:center;line-height:137%'><span
style='font-size:8.0pt;line-height:137%;font-family:"Courier New"'># (c) EIS
Group LTD, 2016 (scripts and setup)          #</span></p>

<p class=MsoNormal align=center style='text-align:center;line-height:137%'><span
style='font-size:8.0pt;line-height:137%;font-family:"Courier New"'># (License)
GPL                                 #</span></p>

<p class=MsoNormal align=center style='text-align:center;line-height:137%'><span
style='font-size:8.0pt;line-height:137%;font-family:"Courier New"'># Donated to
OpenSource by EIS Group, 2016.     #</span></p>

<p class=MsoNormal align=center style='text-align:center;line-height:137%'><span
style='font-size:8.0pt;line-height:137%;font-family:"Courier New"'># Authors:
Alexei Roudnev , Andrey Saveliev     #</span></p>

<p class=MsoNormal align=center style='text-align:center;line-height:137%'><span
style='font-size:8.0pt;line-height:137%;font-family:"Courier New"'>#                                          
    #</span></p>

<p class=MsoNormal align=center style='text-align:center;line-height:137%'><span
style='font-size:8.0pt;line-height:137%;font-family:"Courier New"'>#      open-source@eisgroup.com             
   #</span></p>

<p class=MsoNormal align=center style='text-align:center;line-height:137%'><span
style='font-size:8.0pt;line-height:137%;font-family:"Courier New"'>#  or  
aprudnev@gmail.com                      #</span></p>

<p class=MsoNormal align=center style='text-align:center;line-height:137%'><span
style='font-size:8.0pt;line-height:137%;font-family:"Courier New"'>#  URL;
http://eisgroup.com                     #</span></p>

<p class=MsoNormal align=center style='text-align:center;line-height:137%'><span
style='font-size:8.0pt;line-height:137%;font-family:"Courier New"'>#####################################################</span></p>

<p class=MsoNormal style='line-height:137%'>Software is based on OpenSource
Linux software and is provided ‘As Is’, no guarantees.</p>

<p class=MsoNormal>This document describe files and objects, used in VTI
router, and their layouts.</p>

<p class=MsoNormal>(Document source  - <a
href="https://docs.google.com/document/d/1JKRTOtmFycApsS8Fxa3RsCPOHr-RHjHau9XAPrkaIPY/edit#head"><span
style='color:#1155CC'>https://docs.google.com/document/d/1JKRTOtmFycApsS8Fxa3RsCPOHr-RHjHau9XAPrkaIPY/edit#head</span></a>
- here is the recent version)</p>

<p class=MsoNormal>&nbsp;</p>

<h2><a name="_v795s5lio260"></a>VTI tunnels and their status.</h2>

<p class=MsoNormal>Primary task for this router is to keep VTI tunnels, where
VTI is for Virtual Tunnel Interface, which wraps around standard IPSEC tunnel,
so that while network uses normal IPSEC protocol and normal IPSEC packets
format, router see it not as abstract ‘ipsec access list’ (as in Cisco ASA or
in policy based IPSEC) but as normal network interface, with IP address,
netmask, possible routing over it and so on - when 2 routers are connected by
VTI, everything which comes into vti interface on one router is received from
vti interface on other router.</p>

<h2><a name="_bkc3idy61gca"></a>Components.</h2>

<p class=MsoNormalCxSpFirst style='margin-left:.5in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>For
IPSEC and VTI support  - strongswan. Other ‘swan’ systems do not support it or
has serious bugs. It is located in /etc/strongswan</p>

<p class=MsoNormalCxSpMiddle style='margin-left:.5in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Linux
version - we use CentOS7, but update kernel to kernel 4. There is a good chance
that it can work with Ubuntu, just it was not tested (and initial setup script
will not work).</p>

<p class=MsoNormalCxSpMiddle style='margin-left:.5in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>For
routing - quagga. It is not so stable and clean as Cisco IOS, but it works
pretty well, if you do not try to make something fancy. Quagga is located in
/etc/quagga.</p>

<p class=MsoNormalCxSpMiddle style='margin-left:.5in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>For
VTI management - our scripts, mostly written on shell. They are located in /usr/local/scripts,
together with template files for strongswan and quagga, which are installed by
INITIAL_SETUP.sh and replace some default files in them.</p>

<p class=MsoNormalCxSpLast style='margin-left:.5in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>One
extra component is health monitoring script; it is called by cron  every 10
minutes. It was required, because strongswan do not provide persistent
connections by itself, and all together router-to-AWS connections has a
tendency to disappear or freeze, in rare cases. To prevent it, we added script
which check enabled tunnels, and if some are down or can not ping, try to
reestablish it (after it was created, we did not experience a single outage for
a few month, running 2 VTI routers per each AWS network for redundancy).</p>

<h2><a name="_cfwjhbohirbg"></a>Directories and files.</h2>

<p class=MsoNormalCxSpFirst style='margin-left:.5in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b>/usr/local/scripts</b>
(symlink as ~root/scripts) - VTI management scripts and work directory for
‘awailable’ vti interfaces. </p>

<p class=MsoNormalCxSpMiddle style='margin-left:1.0in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b>WORK</b>
- directory for work; place aws description files here for the parser. System
creates WORK/`hostname -s`.d directory for ‘available’ vti interfaces (it
creates vtiN.property file when yu run aws parser or add vti manually).</p>

<p class=MsoNormalCxSpMiddle style='margin-left:1.5in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b>WORK/`hostname
-s`.d</b> - directory with ‘vtiN.properties’ files</p>

<p class=MsoNormalCxSpMiddle style='margin-left:1.0in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b>FILES.d</b>
- contains files we copy into /etc/ for our scripts; they include fresh quagga
config, very important up/down scripts for strongswan and our strongswan
configuration files, crontab file for automated health monitoring and self
repair, and so on.</p>

<p class=MsoNormal style='margin-left:.5in'>Scripts themselves.</p>

<p class=MsoNormalCxSpMiddle style='margin-left:1.0in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b>./INITIAL_SETUP.sh</b>
- it configure system itself (very first time) and can reconfigure (remove old configuration
and create fresh empty one) IPSEC and routig system(s), and can add necessary
rpm’s (except kernel) as well. It is interactive script, just call it ‘cd
~/scripts; ./INITIAL_SETUP.sh’; It store server configuration in
/etc/sysconfig/`hostname -s`.properties  and can reuse them.</p>

<p class=MsoNormalCxSpMiddle style='margin-left:1.0in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b>./VTI_OPS.sh</b>
(alias <b>VTI</b>) - main script to add / remove / enable / disable / check
status. System creates shortcut to it, which can be called ‘<b>VTI</b>’ as a
root from any place. Typical commands are:</p>

<p class=MsoNormalCxSpMiddle style='margin-left:1.5in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>VTI
-add vti1 vti2 - create files for vti1 and vti2 (they must be ‘available’) and
place it in DISABLED mode. </p>

<p class=MsoNormalCxSpMiddle style='margin-left:1.5in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>VTI
-enable vti1 vti2 - enable (activate) previously created interfaces vti1 and
vti2</p>

<p class=MsoNormalCxSpMiddle style='margin-left:1.5in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>VTI
-disable vti1 vti2 - disable (deactivate) vti1 and vti2</p>

<p class=MsoNormalCxSpMiddle style='margin-left:1.5in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>VTI
-remove vti1 vti2 - remove all files (except created when done ‘available)
related to these interfaces (not just in strongswan, but in quaggam too).</p>

<p class=MsoNormalCxSpMiddle style='margin-left:1.0in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b>./VTI_ADD.sh
</b>- used to create vti (property file) manually; it is interactive script
which ask questions and creates description of interface. By default, property
file is created in WORK/`hostname -s`.d directory, you can specify different
one by -d option and add directory for other side of tunnel by -r option. Can
be used for example to describe interconnection between our own routers.</p>

<p class=MsoNormalCxSpMiddle style='margin-left:1.0in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b>./VTI_ADDAWS.sh
[options] aws_description_file [vti1 [vti2]] </b>- aws configuration parser; it
read VPN description file, provided by AWS, and create property files (or file,
if you configure single vti only) for vti interfaces (they became <b>AVAILABLE</b>).</p>

<p class=MsoNormalCxSpMiddle style='margin-left:1.0in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b>./VTI_RM.sh
vtiN</b> - removes properties file (notice - you can remove properties of
active VTI, it just wil make it unavailable for future -add operation). </p>

<p class=MsoNormalCxSpMiddle style='margin-left:1.0in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Few
other  scripts are not used in normal life:</p>

<p class=MsoNormalCxSpMiddle style='margin-left:1.5in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>update_kernel.sh
- used only when creatig appliance, no need to run it.</p>

<p class=MsoNormalCxSpMiddle style='margin-left:1.5in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>refresh_scripts.sh
- used to resync scripts and files from this directory (from FILES.d) into the
system, and when we maintain sccripts sources outside of router itself.</p>

<p class=MsoNormalCxSpMiddle style='margin-left:1.5in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>SYNC_AVAIL.sh
- used only if you create properties in non standard place.</p>

<p class=MsoNormalCxSpMiddle style='margin-left:.5in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b>/etc/strongswan/ipsec-vti.sh</b>
- main internal script which is called by strongswan when status of VTI
changes; it can be updated by INITIAL_SETUP.sh . Do not change it!</p>

<p class=MsoNormalCxSpMiddle style='margin-left:.5in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b>/etc/strongswan/restart_vti.sh</b>
- it must be called by cron, and it check enabled tunnels and try to reconnect
them if they fail. It must be called every 5 - 10 minutes (and it is called
every 10 minutes by default in appliance).</p>

<p class=MsoNormalCxSpMiddle style='margin-left:.5in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b>/etc/quagga/reset_vti.sh</b>
- this script is called internally to let quagga router know about new vti
interface. Do not change / remove.</p>

<p class=MsoNormalCxSpMiddle style='margin-left:.5in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b>/etc/strongswan/vti.d</b>
- directory, where we create files for vti configuration in swan. For each
active VTI interface (for example, vtiN), 3 files will be created:</p>

<p class=MsoNormalCxSpMiddle style='margin-left:1.0in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>/etc/strongswan/vti.d/<b>vtiN.secrets</b>
- file with shared key</p>

<p class=MsoNormalCxSpMiddle style='margin-left:1.0in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>/etc/strongswan/vti.d/<b>vtiN.init</b>
- vti description created for ipsec-vti.sh script. It contain information such
as IP addresses, MTU, start/stop scripts and so on. </p>

<p class=MsoNormalCxSpMiddle style='margin-left:1.0in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>/etc/strongswan/vti.d/<b>vtiN.conf</b>
- strongswan configuration for this VTI.</p>

<p class=MsoNormalCxSpMiddle style='margin-left:.5in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b>/etc/strongswan/vti.d/.DISABLED</b>
- directory for disabled vti interfaces - vti.conf is crated in it first (so
you can edit it before making active) and placed back here when yoiu ‘disable’
interface.</p>

<p class=MsoNormalCxSpMiddle style='margin-left:.5in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b>/etc/sysconfig/iptables</b>
- this file is adjusted by the system so that IPSEC packets can pass thru.</p>

<p class=MsoNormalCxSpMiddle style='margin-left:.5in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b>/etc/quagga/bgp.conf</b>
- file is adjusted by the system when you -add/-delete interface (by VTI
command) Run ‘vtysh , then sh run’ to see configuration.</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>See APPENDIX for the script(s) arguments.</p>

<h2><a name="_hrvw39imifu7"></a>File formats.</h2>

<p class=MsoNormal>You can edit some files manually, so we show file which are
created, when new VTI is created.</p>

<p class=MsoNormalCxSpMiddle style='margin-left:.5in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>When
aws VPN file is parsed or VRI added manually, file
/usr/local/scripts/WORK/`hostname -s`.d/vtiN.properties is created. Here is
example of this file:</p>

<p class=MsoNormal>&nbsp;</p>

<table class=a border=1 cellspacing=0 cellpadding=0 width=624 style='border-collapse:
 collapse;border:none'>
 <tr>
  <td width=624 valign=top style='width:6.5in;border:solid black 1.0pt;
  padding:5.0pt 5.0pt 5.0pt 5.0pt'>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>### Generated Thu Oct 27 20:29:20 PDT 2016</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>VTI=&quot;vti1&quot;</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>VTI_MTU=&quot;1420&quot;</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>VTI_OIP_LOCAL=&quot;63.2xx.2xx.38&quot;</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>VTI_OIP_REMOTE=&quot;52.25.31.90&quot;</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>LOCAL_GW=&quot;63.2xx.2xx.1&quot;</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>VTI_IIP_LOCAL=&quot;169.254.13.22/30&quot;</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>VTI_IIP_REMOTE=&quot;169.254.13.21/30&quot;</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>VTI_PSK=&quot;xxxxDEJB2wtXzc4jYRGvADIhVL5xxxx&quot;</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>VTI_MARK=&quot;12&quot;</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>#### OPTIONAL</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>ID=&quot;aws23_dev2lab23gw02_GW1&quot;</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>AWS_ID=&quot;vpn-05e0fe17&quot;</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>VTI_BGP_LOCAL_AS=&quot;65003&quot;</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>VTI_BGP_REMOTE_AS=&quot;7224&quot;</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>VTI_BGP_LOCAL_IP=&quot;169.254.13.22/30&quot;</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>VTI_BGP_REMOTE_IP=&quot;169.254.13.21&quot;</span></p>
  <p class=MsoNormal style='line-height:normal'>&nbsp;</p>
  <p class=MsoNormal style='line-height:normal'>&nbsp;</p>
  </td>
 </tr>
</table>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>Most options are obvious; some need comment:</p>

<p class=MsoNormal><b>LOCAL_GW</b> - when tunnel is created, system adds
routing to the VTI_OIP_REMOTE address, via specified LOCAL_GW. </p>

<p class=MsoNormal><b>VTI_MARK</b> - uniq number for this VTI, in 8-base (so it
can not be 9 for example); auto generated.</p>

<p class=MsoNormal><b>ID</b> - added to vtiN connection name. Can be empty or
can be some comment you use to recognize VTI purpose. You will see it in  ‘VTI
-status’ output.</p>

<p class=MsoNormal>*BGP* options - you can specify unique local BGP for each
bgp connection. If BGP options are not specified, bgp configuration will not be
updated.</p>

<p class=MsoNormal>Extra options, not reflected herem are:</p>

<p class=MsoNormal><b>VTI_O1 ... VTI_O5</b> will be added into connection
configuration for strongswan, so you can customize connection using any
strongswan configuration options.</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>When this file exist, VTI -list show this vti in list of
available, as here:</p>

<p class=MsoNormal>&nbsp;</p>

<table class=a0 border=1 cellspacing=0 cellpadding=0 width=624
 style='border-collapse:collapse;border:none'>
 <tr>
  <td width=624 valign=top style='width:6.5in;border:solid black 1.0pt;
  padding:5.0pt 5.0pt 5.0pt 5.0pt'>
  <p class=MsoNormal><span style='font-size:8.0pt;line-height:115%;font-family:
  "Courier New"'>VTI -list<br>
  Active: *</span></p>
  <p class=MsoNormal><span style='font-size:8.0pt;line-height:115%;font-family:
  "Courier New"'>Disabled: vti1 vti2</span></p>
  <p class=MsoNormal><span style='font-size:8.0pt;line-height:115%;font-family:
  "Courier New"'>Available: vti1 vti2</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormalCxSpMiddle style='margin-left:.5in;text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Next,
vti interface must be added into the system (it will be added in disabled
state). VTI -add vtiN creates vtiN.init and vtiN.secrets files in
/etc/strongswan/vti.d, and vtiN.conf file in /etc/strongswan/vti.d/.DISABLED.
Let’s see these files:<br>
<br>
</p>

<p class=MsoNormal>Shared key is in *.secrets file:</p>

<table class=a1 border=1 cellspacing=0 cellpadding=0 width=624
 style='border-collapse:collapse;border:none'>
 <tr>
  <td width=624 valign=top style='width:6.5in;border:solid black 1.0pt;
  padding:5.0pt 5.0pt 5.0pt 5.0pt'>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>cat /etc/strongswan/vti.d/vti1.secrets</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>63.2xx.2xx.38 52.25.xx.90 : PSK
  xxxxxEJB2wtXzc4jYRGvADIhVLxxxxx</span></p>
  <p class=MsoNormal style='line-height:normal'>&nbsp;</p>
  </td>
 </tr>
</table>

<p class=MsoNormal>Strongswan configuration is in .conf file:</p>

<p class=MsoNormal>&nbsp;</p>

<table class=a2 border=1 cellspacing=0 cellpadding=0 width=624
 style='border-collapse:collapse;border:none'>
 <tr>
  <td width=624 valign=top style='width:6.5in;border:solid black 1.0pt;
  padding:5.0pt 5.0pt 5.0pt 5.0pt'>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>cat /etc/strongswan/vti.d/.DISABLED/vti1.conf</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>#BEGIN:vti1</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>conn vti1.aws23_dev2lab23gw02_GW1</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>       left=63.2xx.2xx.38</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>       right=52.25.1xx.90</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>       auto=start</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>       mark=12</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>       forceencaps=yes</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>#END:vti1</span></p>
  <p class=MsoNormal style='line-height:normal'>&nbsp;</p>
  </td>
 </tr>
</table>

<p class=MsoNormal>If you specified VTI_O1 - VTI_O5 in properties file,  they
will be added here, too. As you can see, connection name ALWAYS starts with vti
interface name, but then can has a suffix with any mnemonics name.</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>And IP configuration file, used by our script:</p>

<table class=a3 border=1 cellspacing=0 cellpadding=0 width=624
 style='border-collapse:collapse;border:none'>
 <tr>
  <td width=624 valign=top style='width:6.5in;border:solid black 1.0pt;
  padding:5.0pt 5.0pt 5.0pt 5.0pt'>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>cat /etc/strongswan/vti.d/vti1.init</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'># Created Thu Oct 27 20:37:06 PDT 2016</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'># aws23_dev2lab23gw02_GW1</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'># vpn-05e0fe17</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>VTI_INTERFACE=vti1</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>VTI_LOCALADDR=169.254.13.22/30</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>VTI_REMOTEADDR=169.254.13.21/30</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>VTI_MTU=1420</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>VTI_UP=&quot;/etc/quagga/reset_vti.sh vti1&quot;</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>VTI_DOWN=&quot;/etc/quagga/reset_vti.sh vti1&quot;</span></p>
  <p class=MsoNormal style='line-height:normal'>&nbsp;</p>
  </td>
 </tr>
</table>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>Few extra lines will be added into quagga configuration,
too:<br>
<br>
</p>

<table class=a4 border=1 cellspacing=0 cellpadding=0 width=624
 style='border-collapse:collapse;border:none'>
 <tr>
  <td width=624 valign=top style='width:6.5in;border:solid black 1.0pt;
  padding:5.0pt 5.0pt 5.0pt 5.0pt'>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>router bgp 65003</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'> ...</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'> ...</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'> neighbor 169.254.13.21 remote-as 7224</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'> neighbor 169.254.13.21 route-map from_aws in</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>...</span></p>
  <p class=MsoNormal style='line-height:normal'>&nbsp;</p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>ip route 52.25.xx.90/32 63.2xx.2xx.1</span></p>
  <p class=MsoNormal style='line-height:normal'>&nbsp;</p>
  <p class=MsoNormal style='line-height:normal'>&nbsp;</p>
  </td>
 </tr>
</table>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>So, system added bgp peer, added inbound filter (if
route-map exists, else this line will not be added), and most important, static
route to the remote IP (remember, even if vti router is connected to OUTSIDE
network, it do not have default routing here and access is restricted in
iptables.</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>Once we verified configuration (and adjusted it) we can
activate VTI interface.</p>

<p class=MsoNormal>&nbsp;</p>

<table class=a5 border=1 cellspacing=0 cellpadding=0 width=624
 style='border-collapse:collapse;border:none'>
 <tr>
  <td width=624 valign=top style='width:6.5in;border:solid black 1.0pt;
  padding:5.0pt 5.0pt 5.0pt 5.0pt'>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>[root@dev2-lab23-gw02 scripts]# VTI -list</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>Active: *</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>Disabled: vti1 vti2</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>Available: vti1 vti2</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>[root@dev2-lab23-gw02 scripts]# VTI -enable vti1</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>vti1 enabled</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>Reloading strongSwan IPsec configuration...</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>generating QUICK_MODE request 410661295 [ HASH SA
  No KE ID ID ]</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>sending packet: from 63.2xx1.2xx.38[4500] to
  52.25.xx.90[4500] (460 bytes)</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>received packet: from 52.25.xx.90[4500] to
  63.2xx.2xx.38[4500] (444 bytes)</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>parsed QUICK_MODE response 410661295 [ HASH SA No
  KE ID ID ]</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>CHILD_SA vti1.aws23_dev2lab23gw02_GW1{10}
  established with SPIs cf6f7955_i 7a71f5ec_o and TS 0.0.0.0/0 === 0.0.0.0/0</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>connection 'vti1.aws23_dev2lab23gw02_GW1'
  established successfully</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>Reloading strongSwan IPsec configuration...</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>[root@dev2-lab23-gw02 scripts]# VTI -list</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>Active: vti1</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>Disabled: vti2</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>Available: vti1 vti2</span></p>
  <p class=MsoNormal style='line-height:normal'>&nbsp;</p>
  </td>
 </tr>
</table>

<p class=MsoNormal>This command moved vti.conf from .DISABLED directory and
re-read strongswan configuration; in turn, strongswan establish connection and
call /etc/strongswan/vti-ipsec.sh script which establish VTI interface (zcript
adjust some system parameters, too).<br>
<br>
</p>

<p class=MsoNormal>See interface status:<br>
<br>
</p>

<table class=a6 border=1 cellspacing=0 cellpadding=0 width=624
 style='border-collapse:collapse;border:none'>
 <tr>
  <td width=624 valign=top style='width:6.5in;border:solid black 1.0pt;
  padding:5.0pt 5.0pt 5.0pt 5.0pt'>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'> VTI -status</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>vti1.aws23_dev2lab23gw02_GW1: #3, ESTABLISHED,
  IKEv1, a36f0a2326887e3d:ad17b945a3fc85bd</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>  local  '63.251.228.38' @ 63.251.228.38[4500]</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>  remote '52.25.31.90' @ 52.25.31.90[4500]</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>  AES_CBC-256/HMAC_SHA2_256_128/PRF_HMAC_SHA2_256/MODP_2048_256</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>  established 203s ago, rekeying in 27829s</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>  vti1.aws23_dev2lab23gw02_GW1: #9, reqid 3,
  INSTALLED, TUNNEL-in-UDP, ESP:AES_CBC-128/HMAC_SHA2_256_128/MODP_2048_256</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>       installed 203s ago, rekeying in 2432s,
  expires in 3397s</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>       in  c9e781f5,        0 bytes,      0
  packets,    7s ago</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>       out fcd13ebc,        60 bytes,     1
  packets,    86s ago</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>       local  0.0.0.0/0</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>       remote 0.0.0.0/0</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>  vti1.aws23_dev2lab23gw02_GW1: #10, reqid 3,
  INSTALLED, TUNNEL-in-UDP, ESP:AES_CBC-128/HMAC_SHA2_256_128/MODP_2048_256</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>       installed 198s ago, rekeying in 2388s,
  expires in 3402s</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>       in  cf6f7955,        0 bytes,      0
  packets,    7s ago</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>       out 7a71f5ec,        0 bytes,      0
  packets</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>       local  0.0.0.0/0</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>       remote 0.0.0.0/0</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>  vti1.aws23_dev2lab23gw02_GW1: #11, reqid 3,
  INSTALLED, TUNNEL-in-UDP, ESP:AES_CBC-128/HMAC_SHA2_256_128/MODP_2048_256</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>       installed 194s ago, rekeying in 2451s,
  expires in 3406s</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>       in  c0f95cce,   2261 bytes, 33 packets,   7s
  ago</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>       out 61eb688d,   2842 bytes, 44 packets,   7s
  ago</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>       local  0.0.0.0/0</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>       remote 0.0.0.0/0</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>vti1: flags=209&lt;UP,POINTOPOINT,RUNNING,NOARP&gt; 
  mtu 1420</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>10.20.23.0    169.254.13.21   255.255.255.0   UG  
      0 0           0 vti1</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>169.254.13.20   0.0.0.0           255.255.255.252
  U          0 0           0 vti1</span></p>
  <p class=MsoNormal style='line-height:normal'>&nbsp;</p>
  <p class=MsoNormal style='line-height:normal'>&nbsp;</p>
  </td>
 </tr>
</table>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>As you can see, we have now 10.20.23.0/24 routing, it comes
from AWS by BGP.</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>We can disable interface, it just move vti1.conf back to
DISABLED and re-read configuration so strongswan disconnect tunnels.</p>

<p class=MsoNormal>&nbsp;</p>

<table class=a7 border=1 cellspacing=0 cellpadding=0 width=624
 style='border-collapse:collapse;border:none'>
 <tr>
  <td width=624 valign=top style='width:6.5in;border:solid black 1.0pt;
  padding:5.0pt 5.0pt 5.0pt 5.0pt'>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'> VTI -disable vti1</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>Reloading strongSwan IPsec configuration...</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>closing CHILD_SA vti1.aws23_dev2lab23gw02_GW1{9}
  with SPIs c9e781f5_i (0 bytes) fcd13ebc_o (60 bytes) and TS 0.0.0.0/0 ===
  0.0.0.0/0</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>sending DELETE for ESP CHILD_SA with SPI c9e781f5</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>generating INFORMATIONAL_V1 request 908048759 [
  HASH D ]</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>sending packet: from 63.251.228.38[4500] to
  52.25.31.90[4500] (92 bytes)</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>closing CHILD_SA vti1.aws23_dev2lab23gw02_GW1{10}
  with SPIs cf6f7955_i (0 bytes) 7a71f5ec_o (0 bytes) and TS 0.0.0.0/0 ===
  0.0.0.0/0</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>sending DELETE for ESP CHILD_SA with SPI cf6f7955</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>generating INFORMATIONAL_V1 request 2232773923 [
  HASH D ]</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>sending packet: from 63.251.228.38[4500] to
  52.25.31.90[4500] (92 bytes)</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>closing CHILD_SA vti1.aws23_dev2lab23gw02_GW1{11}
  with SPIs c0f95cce_i (4423 bytes) 61eb688d_o (5056 bytes) and TS 0.0.0.0/0
  === 0.0.0.0/0</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>IKE_SA [3] closed successfully</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>vti1 disabled</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>Reloading strongSwan IPsec configuration...</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>[root@dev2-lab23-gw02 scripts]# VTI -status</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>[root@dev2-lab23-gw02 scripts]#</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal>And finally we can delete interface from the system, so it’s
IP and number can be reused:<br>
<br>
<br>
</p>

<table class=a8 border=1 cellspacing=0 cellpadding=0 width=624
 style='border-collapse:collapse;border:none'>
 <tr>
  <td width=624 valign=top style='width:6.5in;border:solid black 1.0pt;
  padding:5.0pt 5.0pt 5.0pt 5.0pt'>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>VTI -delete vti1</span></p>
  <p class=MsoNormal style='line-height:normal'>&nbsp;</p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>Hello, this is Quagga (version 0.99.22.4).</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>Copyright 1996-2005 Kunihiro Ishiguro, et al.</span></p>
  <p class=MsoNormal style='line-height:normal'>&nbsp;</p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>dev2-lab23-gw02.sjclab.exigengroup.com#  conf t</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>dev2-lab23-gw02.sjclab.exigengroup.com(config)#        no
  ip route 52.25.xx.xx/32 63.2xx.2xx.1</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>dev2-lab23-gw02.sjclab.exigengroup.com(config)#        exit</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>dev2-lab23-gw02.sjclab.exigengroup.com#  write mem</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>Building Configuration...</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>Configuration saved to /etc/quagga/zebra.conf</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>Configuration saved to /etc/quagga/ospfd.conf</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>Configuration saved to /etc/quagga/bgpd.conf</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>[OK]</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>dev2-lab23-gw02.sjclab.exigengroup.com#</span></p>
  <p class=MsoNormal style='line-height:normal'>&nbsp;</p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>Hello, this is Quagga (version 0.99.22.4).</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>Copyright 1996-2005 Kunihiro Ishiguro, et al.</span></p>
  <p class=MsoNormal style='line-height:normal'>&nbsp;</p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>dev2-lab23-gw02.sjclab.exigengroup.com# conf t</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>dev2-lab23-gw02.sjclab.exigengroup.com(config)#
  router bgp 65003</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>dev2-lab23-gw02.sjclab.exigengroup.com(config-router)#
  no neighbor 169.254.13.21 remote-as 7224</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>dev2-lab23-gw02.sjclab.exigengroup.com(config-router)#
  no neighbor 169.254.13.21 local-as 65003</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>% Specify remote-as or peer-group commands first</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>dev2-lab23-gw02.sjclab.exigengroup.com(config-router)#
  exit</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>dev2-lab23-gw02.sjclab.exigengroup.com(config)#            
    exit</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>dev2-lab23-gw02.sjclab.exigengroup.com# write mem</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>Building Configuration...</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>Configuration saved to /etc/quagga/zebra.conf</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>Configuration saved to /etc/quagga/ospfd.conf</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>Configuration saved to /etc/quagga/bgpd.conf</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>[OK]</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>dev2-lab23-gw02.sjclab.exigengroup.com#</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>Reloading strongSwan IPsec configuration...</span></p>
  <p class=MsoNormal style='line-height:normal'>&nbsp;</p>
  <p class=MsoNormal style='line-height:normal'>&nbsp;</p>
  </td>
 </tr>
</table>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>And remove property file cd ~/scripts; ./VTI_RM.sh vti1 </p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>That’s it. THis is full life circle of VTI interface and all
commands involved in it’s management.</p>

<p class=MsoNormal>&nbsp;</p>

<h1><a name="_nmxdn19nxdus"></a>&nbsp;</h1>

<span style='font-size:11.0pt;line-height:115%;font-family:"Arial","sans-serif"'><br
clear=all style='page-break-before:always'>
</span>

<p class=MsoNormal>&nbsp;</p>

<h1><a name="_gixf7xko4loo"></a>&nbsp;</h1>

<h1><a name="_tyxklp2ui5gz"></a>APPENDIX. Scripts options.</h1>

<p class=MsoNormal><span style='font-size:8.0pt;line-height:115%;font-family:
"Courier New"'>VTI or scripts/VTI_OPS.sh:</span></p>

<table class=a9 border=1 cellspacing=0 cellpadding=0 width=624
 style='border-collapse:collapse;border:none'>
 <tr>
  <td width=624 valign=top style='width:6.5in;border:solid black 1.0pt;
  padding:5.0pt 5.0pt 5.0pt 5.0pt'>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>VTI</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>Usage: /usr/local/scripts/VTI_OPS.sh [-e
  &lt;/etc&gt;] [-d &lt;DIR&gt;] [-noreload] [-nobgp] {-add|-delete|-enable|-disable}
  vti1 ...</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>   /usr/local/scripts/VTI_OPS.sh [-e &lt;/etc&gt;]
  -d &lt;dir&gt;] -status|-list [vtiN]</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal><span style='font-size:8.0pt;line-height:115%;font-family:
"Courier New"'>VTI_ADDAWS.sh</span></p>

<table class=aa border=1 cellspacing=0 cellpadding=0 width=624
 style='border-collapse:collapse;border:none'>
 <tr>
  <td width=624 valign=top style='width:6.5in;border:solid black 1.0pt;
  padding:5.0pt 5.0pt 5.0pt 5.0pt'>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>./VTI_ADDAWS.sh</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>Using directory WORK/dev2-lab23-gw02.d - you can
  change it by -d &lt;dir&gt; option</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>Usage: ./VTI_ADDAWS.sh [-d directory] [-f]
  &lt;generic-config-file-from-amazon.txt&gt; [vti1 [vti2]]</span></p>
  <p class=MsoNormal style='line-height:normal'>&nbsp;</p>
  </td>
 </tr>
</table>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal><span style='font-size:8.0pt;line-height:115%;font-family:
"Courier New"'>VTI_ADD.sh </span></p>

<p class=MsoNormal>&nbsp;</p>

<table class=ab border=1 cellspacing=0 cellpadding=0 width=624
 style='border-collapse:collapse;border:none'>
 <tr>
  <td width=624 valign=top style='width:6.5in;border:solid black 1.0pt;
  padding:5.0pt 5.0pt 5.0pt 5.0pt'>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>-d &lt;work directory&gt; - default WORK/`hostname
  -s`.d</span></p>
  <p class=MsoNormal style='line-height:normal'><span style='font-size:8.0pt;
  font-family:"Courier New"'>-r &lt;work directory for reverse tunnel&gt; - if
  specified, it creates properties for 2 ends of tunnel.</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal>&nbsp;</p>

</div>

</body>

</html>
